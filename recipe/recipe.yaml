schema_version: 1

context:
  name: pytango
  version: "10.1.3"

package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  url: https://pypi.org/packages/source/${{ name[0] }}/${{ name }}/${{ name }}-${{ version }}.tar.gz
  sha256: 83bde0138cae0fee22973f536691dfcb534d0012f548c1104c7ff104e3be46df

build:
  number: 0
  skip: match(python, "<3.10")
  script: ${{ PYTHON }} -m pip install . -vv

requirements:
  build:
    - if: build_platform != target_platform
      then:
        - python
        - cross-python_${{ target_platform }}
        - numpy
    - ${{ compiler('cxx') }}
    - ${{ stdlib("c") }}
    - cmake
    - if: unix
      then:
        - make
        - pkg-config
  host:
    - python
    - pip
    - cppzmq
    - cpptango >=10.1.1,<10.2.0a0
    - pybind11 >=3.0.1
    - numpy
    - omniorb-libs
    - scikit-build-core
    - pybind11-stubgen
    - ruff
    - if: match(python, "<3.13")
      then: typing_extensions >=4.5.0
  run:
    - python
    - packaging
    - psutil >=5.3.0
    - docstring_parser
    - if: match(python, "<3.13")
      then: typing_extensions >=4.5.0
    - if: unix
      then:
        - opentelemetry-api
        - opentelemetry-sdk
        - opentelemetry-exporter-otlp-proto-grpc
        - opentelemetry-exporter-otlp-proto-http

tests:
  - python:
      imports:
        - PyTango
        - tango
  - script:
      # Skip some flaky tests
      - if: unix and not aarch64
        then: pytest -k "not test_attribute_poll and not test_async_events_subscription" || pytest --lf
      - if: aarch64
        then: pytest -k "not test_subscribe_data_ready_event and not test_attribute_poll and not test_async_events_subscription and not test_databaseds.py" || pytest --lf
      # Only basic tests on windows
      - if: win
        then:
          - pytest -c pytest_win_config.toml tests/test_device_proxy.py::test_ping
          - pytest -c pytest_win_config.toml "tests/test_attribute_proxy.py::test_state_status[scalar_int]"
    files:
      source:
        - tests/
        - pyproject.toml
        - if: win
          then: pytest_win_config.toml
    requirements:
      run:
        - pytest
        - pytest-asyncio
        - pytest-env
        - pytest-forked
        - pytest-timeout
        - gevent
        - tango-test =3.12

about:
  summary: Python binding for the TANGO control system
  license: LGPL-3.0-or-later
  license_file:
    - LICENSE.txt
  homepage: http://pytango.rtfd.io
  repository: https://gitlab.com/tango-controls/pytango
  documentation: http://pytango.rtfd.io

extra:
  recipe-maintainers:
    - yamedvedya
    - beenje
    - ajoubertza
